
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Independent Parliamentary Standards Authority - MP Expenses</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- D3  CSS -->
    <link href="css/d3.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/dashboard.css" rel="stylesheet">


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  </head>

  <body>
    <nav id="navbar" class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <span class="label label-alpha">ALPHA</span>
          <a class="navbar-brand" href="#">IPSA - MPs' Expenses</a>

        </div>

        <h4 class="navbar-text white center"><span class="label label-default">Dates selected: 1 April 2014 - 31 March 2015</span></h4>

        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">Help</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3 col-md-2 sidebar">
                <h2>Instructions</h2>
                <p>To find details on a MP's expenses, zoom and click on a constituency on the map.  Alternatively use one of the filters below to help you search for an MP.</p>
                <h2>Filters</h2>
                <br />
                <span class="label label-default">Year Finder</span>
                <div class="input-group" >
                  <div id="year" class="input-group-btn">
                    <button  type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">2014-15 <span class="caret"></span></button>
                    <ul class="dropdown-menu dropdown-menu-left">
                        <li><a id="year2015" href="#">2015-16 (incomplete)</a></li>
                        <li><a id="year2014" href="#">2014-15</a></li>
                        <li><a id="year2013" href="#">2013-14</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a id="parlia2010" href="#">2010-15</a></li>
                    </ul>
                  </div><!-- /btn-group -->
                  <span class="input-group-btn">
                    <button id="yearsubmit" class="btn btn-default" type="button">Load</button>
                  </span>
                </div><!-- /input-group -->
                <br />
                <span class="label label-default">Postcode Finder</span>
                <div class="input-group">               
                  <input id="postcode" type="text" class="form-control" placeholder="Postcode">
                  <span class="input-group-btn">
                    <button id="postcodesubmit" class="btn btn-default" type="button">Find</button>
                  </span>
                </div>
                <br />
                <span class="label label-default">MP Finder</span>                
                <div class="input-group">
                  <input id="mporconst" type="text" class="form-control" placeholder="MP">
                  <span class="input-group-btn">
                    <button id="mporconstsubmit" class="btn btn-default" type="button">Find</button>
                  </span>
                </div>
                <br />
                <span class="label label-default">Region Finder</span>
                <div class="input-group" >
                  <div id="regions" class="input-group-btn">
                    <button  type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">All Regions <span class="caret"></span></button>
                    <ul class="dropdown-menu dropdown-menu-left regionslist">
                        <li><a id="all-regions" href="#">All Regions</a></li>
                        <li><a id="Eastern" href="#">East of England</a></li>
                        <li><a id="East-Midlands" href="#">East Midlands</a></li>
                        <li><a id="London" href="#">London</a></li>
                        <li><a id="North-East" href="#">North East</a></li>
                        <li><a id="North-West" href="#">North West</a></li>
                        <li><a id="Northern-Ireland" href="#">Northern Ireland</a></li>
                        <li><a id="Scotland" href="#">Scotland</a></li>
                        <li><a id="South-East" href="#">South East</a></li>
                        <li><a id="South-West" href="#">South West</a></li>
                        <li><a id="Wales" href="#">Wales</a></li>
                    </ul>
                  </div><!-- /btn-group -->
                  <span class="input-group-btn">
                    <button id="regionsubmit" class="btn btn-default" type="button">Load</button>
                  </span>
                </div><!-- /input-group -->
                <br />
                <span class="label label-default">Ministers Finder</span>
                <div class="input-group" >
                  <div id="ministers" class="input-group-btn">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">All Members <span class="caret"></span></button>
                    <ul class="dropdown-menu dropdown-menu-left">
                        <li><a id="ministersnone" href="#">All Members</a></li>
                        <li><a id="heldcabinetpostbetween=" href="#">Cabinet Ministers</a></li>
                        <li><a id="heldshadowcabinetpostbetween" href="#">Shad. Cab. Ministers</a></li>
                    </ul>
                  </div><!-- /btn-group -->
                  <span class="input-group-btn">
                    <button id="regionsubmit" class="btn btn-default" type="button">Load</button>
                  </span>
                </div><!-- /input-group -->
                <div id="footerlicense">
                    <!-- <p>Design: David Tagg-Oram &copy;</p> -->
                </div>
            </div>
            <div id="mainsection" class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
              <div id='map'></div>
            </div>
        </div>
    </div>
    <div id="details">
        <div class="row">
            <div class="col-sm-12 col-md-4">
                <h1 id="mpname"></h1>
                <h2 id="constituency"></h2>
                <p id="party"></p>
                <a id="moreinfo" href="">Click here for more information.</a>
                <input type="hidden" id="ranks" value="" />
            </div>
            <div class="col-sm-12 col-md-8">
                <table id="mptable" class="table table-striped"></table>
            </div>
        </div>
    </div>
    

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="js/ie10-viewport-bug-workaround.js"></script>

    <!-- D3 Javscript
    ================================================== -->
    <script src="js/d3.min.js"></script>
    <script src="js/queue.v1.min.js"></script>
    <script src="js/topojson.v1.min.js"></script>
    <script src="js/d3.legend.min.js"></script>
    <script src="js/lightbox.js"></script>
    <script src="js/lightboxlinechart.js"></script>
    

    <script>

      $.widget( "custom.catcomplete", $.ui.autocomplete, {
        _create: function() {
          this._super();
          this.widget().menu( "option", "items", "> :not(.ui-autocomplete-category)" );
        },
        _renderMenu: function( ul, items ) {
          var that = this,
            currentCategory = "";
          $.each( items, function( index, item ) {
            var li;
            if ( item.category != currentCategory ) {
              ul.append( "<li class='ui-autocomplete-category'>" + item.category + "</li>" );
              currentCategory = item.category;
            }
            li = that._renderItemData( ul, item );
            if ( item.category ) {
              li.attr( "aria-label", item.category + " : " + item.label );
            }
          });
        }
      });

        function getFiscalY(d)
        {
            var fiscalYear;
            if (d.getMonth() > 8)
                { fiscalYear = d.getFullYear() + 1;}
            else {
                fiscalYear = d.getFullYear();}
            return fiscalYear
        }   

    </script>
    <script>

        date = new Date();
        startdate = getFiscalY(date)-2+"-04-01";
        enddate = getFiscalY(date)-1+"-03-31";
    
//Hide MP information bar
$("#details").hide();



// create map

var width = $("#mainsection").width()+70,
    height = window.innerHeight-$("#navbar").height() - 20, 
    centered,
    regionzoom,
    regiontranslate;

var projection = d3.geo.albers()
    .center([0, 54.4])
    .rotate([4.4, 0])
    .parallels([50, 60])
    .translate([width/2,height/2])
    .scale(6*height)
    ;

var zoom = d3.behavior.zoom()
    .scaleExtent([1, 15])
    .translate([0,0])
    .scale(1)
    //.on("zoom", clicked);


var path = d3.geo.path()
    .projection(projection);

var reset = d3.svg.symbol()
    .type('circle');

var zoomin = d3.svg.symbol()
    .type('cross').
    size('150');

var ordinal = d3.scale.ordinal()
  .domain(["Conservatives", "Labour", "SNP", "Liberal Democrats", "DUP", "Sinn Fein", "Plaid Cymru", "SDLP", "Alliance Party", "UKIP", "Green", "Ind./Speaker"])
  .range(["rgba(5, 117, 201, 1)","rgba(237, 30, 14, 1)", "rgba(235, 195, 28, 1)","rgba(254, 131, 0, 1)", "rgba(212, 106, 76, 1)", "rgba(0, 136, 0, 1)","rgba(78, 159, 47, 1)", "rgba(0, 158, 96, 1)", "rgba(255, 215, 0, 1)","rgba(113, 47, 135, 1)", "rgba(120, 195, 30, 1)", "rgba(229, 229, 229, 1)" ]);

var svg = d3.select('#map').append('svg')
    .attr('width', width)
    .attr('height', height)
;

var legendOrdinal = d3.legend.color()
  .shape("path", d3.svg.symbol().type("square").size(150)())
  .shapePadding(10)
  .scale(ordinal);


svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height);

var g = svg.append("g")
        .attr("transform","translate(0,0)");


// tooltip
var tooltip = d3.select('#map').append('div')
    .attr('class', 'tooltip')
;

// load files
queue()
    .defer(d3.csv, "data/constituenciesregions.csv")
    .defer(d3.json, "data/WholeUK.json")
    .defer(d3.tsv, "data/election-2010results.tsv")
    .defer(d3.csv, "data/export-2014.csv")
    .defer(d3.csv, "data/export-2013.csv")
    .defer(d3.csv, "data/export-2012.csv")
    .await(ready) // ready refers to function below
;

function ready(error, constituencydata, topology, electionData,ipsaData2014,ipsaData2013, ipsaData2012) {

    var constituencies = constituencydata;
    var topology = topojson.feature(topology, topology.objects.WholeUK).features;
    var n = constituencies.length;
    var mporconstdata = [];
    var ipsaDataThisYear = ipsaData2014;
    var ipsaDataLastYear = ipsaData2013;

    // join datasets
    // we will add the missing data points to the constituencies object
    
    constituencies.forEach(function(d){

        featureTopoData = topology.filter(
        function(n){ 
            return d.id == n.properties.id
        })
        ;
        
        featureData = electionData.filter(
        function(n){ 
            return d.id == n.ons_gss_code
        })
        ;
        
        d.partyName = featureData[0].party_name;
        d.shareVotes = featureData[0].share_votes;

        featureDataThisYear = ipsaDataThisYear.filter(
        function(n){ 
            if (n.constituency.substring(n.constituency.length-1,n.constituency.length) == 'C') {
                n.constituency = n.constituency.substring(0,n.constituency.length-3)
            }
            return d.constituency_name == n.constituency;
        })
        ;

        featureDataLastYear = ipsaDataLastYear.filter(
        function(n){ 
            if (n.constituency.substring(n.constituency.length-1,n.constituency.length) == 'C') {
                n.constituency = n.constituency.substring(0,n.constituency.length-3)
            }
            return d.constituency_name == n.constituency;
        })
        ;
        d.type = featureTopoData[0].type;
        d.geometry = featureTopoData[0].geometry;
        d.properties = featureTopoData[0].properties;
        
        d.mp = featureDataThisYear[0].mp_name;
        d.costsThisYear = featureDataThisYear[0];
        d.costLastYear = featureDataLastYear[0];
        
        if (featureDataThisYear.length > 1) {
            d.mp2 = featureDataThisYear[1].mp_name;
            d.costsThisYear2 = featureDataThisYear[1];
            d.costLastYear2 = featureDataLastYear[1];

        mporconstdata.push({ label: d.mp2, category: "MP", data:d });
        }

        mporconstdata.push({ label: d.mp, category: "MP", data:d });
        mporconstdata.push({ label: d.constituency_name, category: "Constituency", data:d })
        
    })
    ;
    //Sorts list of MPs and Conts into order
    mporconstdata.sort(function(a, b) {
        if(a.category===b.category) {
            return d3.ascending(a.label, b.label);
        }
            return d3.descending(a.category, b.category);
    });


    // create a polygon for every constituency
    g.selectAll('.constituency')
        .data(constituencies)
        .enter()
        .insert('path')
        // assign id from feature data
        .attr('id', function(d) { return d.id; })
        .attr('d', path)
        .attr('class', function(d){
            return (d.partyName).toLocaleLowerCase().replace(/ /g,'-').replace(/&/g,'-')
                + ' constituency';
        })   
        // tooltip
        .on('mousemove', function(d,i){
            var mouse = d3.mouse(svg.node()).map(
                function (d) {
                    return parseInt(d);
                }
            )
            ;

            tooltip
                .classed('hidden', false)
                .attr('style', 'left:' + (mouse[0]-(d.constituency_name.length)*6) + 'px; top:' + (mouse[1]+30) + 'px')
                // tooltip text:
                .html(
                    '<b>' + d.mp + '</b><br />'
                    + '<b>' + d.constituency_name + '</b></br>' 
                    + d.partyName + '</br>' 
                    + d.shareVotes + '%'
                )
            
        })
        .on('mouseout', function(d,i){
            tooltip.classed('hidden', true)
        })
        // zoom to click
        .on("click",clicked);
        //.on("wheel",zoomed);

    //click on dropdowns function
    $('.dropdown-menu a').on('click', function(){
        $(this).parent().parent().prev().html($(this).html() + '<span class="caret"></span>'); 
        if ($(this).parent().parent().parent().attr("id") == "regions") {
            regionid = $(this).attr("id");
            regiongeos = [];
            constituencies.forEach(function(d){

                if (regionid == "all-regions") {
                    partyclass = d.partyName.toLocaleLowerCase().replace(/ /g,'-').replace(/&/g,'-') + ' constituency';;
                    g.select('#'+d.id).attr('class', partyclass);
                    regionzoom = 1;
                }  
                else if(d.region != regionid) {
                    g.select('#'+d.id).attr("class","constituency");
                }              
                else {
                    regiongeos.push(d.geometry);

                    partyclass = d.partyName.toLocaleLowerCase().replace(/ /g,'-').replace(/&/g,'-') + ' constituency';;
                    g.select('#'+d.id).attr('class', partyclass);
                }


            });

        regionpath = { "type": "GeometryCollection",
                        "geometries": regiongeos
                      }

            bx = path.bounds(regionpath)[1][0]-path.bounds(regionpath)[0][0];
            by = path.bounds(regionpath)[1][1]-path.bounds(regionpath)[0][1];
            if (bx > by) {b = bx} else {b = by}
            k = 500/b;
            if (k > 15) k = 15;
            var centroid = path.centroid(regionpath);
            x = centroid[0];
            y = centroid[1];

            if (k>1) {
                zoom.translate([((width/2)+(-x*k)),((height/2)+(-y*k))]);
            } else {
                zoom.translate([0,0]);
            }

            zoom.scale(k);

            regionzoom = k;
        
        g.transition()
        .duration(1250)
        .attr("transform", "translate(" + (zoom.translate()) + ")scale(" + (zoom.scale()) + ")");


        }


        if ($(this).parent().parent().parent().attr("id") == "ministers") {
            if($(this).attr("id") == "ministersnone") {
                constituencies.forEach(function(d){
                    partyclass = d.partyName.toLocaleLowerCase().replace(/ /g,'-').replace(/&/g,'-') + ' constituency';
                    g.select('#'+d.id).attr('class', partyclass);
                })   
            }
            else {
                xmlurl = "http://data.parliament.uk/membersdataplatform/services/mnis/members/query/membership=all%7Ccommonsmemberbetween="+startdate+"and"+enddate+"%7C"+$(this).attr("id")+startdate+"and"+enddate+"/GovernmentPosts%7COppositionPosts%7CConstituencies/";

                //http://bl.ocks.org/mbostock/ec585e034819c06f5c99 Tutorial on d3 XML
                //http://data.parliament.uk/membersdataplatform/memberquery.aspx#dateinfotable Guide to API
                d3.xml(xmlurl, function(error, data) {

                    membersfeed = [].map.call(data.querySelector("Members").querySelectorAll("Member"), function(member) {
                        return {
                            member_id: member.getAttribute("Member_Id"),
                            pims_id: member.getAttribute("Pims_Id"),
                            dods_id: member.getAttribute("Dods_Id"),
                            display_name: member.querySelector("DisplayAs").textContent,
                            list_name: member.querySelector("ListAs").textContent,
                            date_of_birth: member.querySelector("DateOfBirth").textContent,
                            date_of_death: member.querySelector("DateOfDeath").textContent,
                            party: member.querySelector("Party").textContent,
                            constituency: member.querySelectorAll("Constituencies > Constituency"),
                            governmentposts: member.querySelectorAll("GovernmentPosts > GovernmentPost"),
                            oppositionposts: member.querySelectorAll("OppositionPosts > OppositionPost")
                            
                        };
                        
                    });

                    g.selectAll('.constituency').attr("class","constituency");
                    membersincluded = [];
                    for(i=0;i < membersfeed.length; i++) {
                        name = membersfeed[i].list_name.split(",")[1].trim() + " " + membersfeed[i].list_name.split(",")[0].trim();
                        constituencies.forEach(function(d){
                            if(name == d.mp) {
                                partyclass = d.partyName.toLocaleLowerCase().replace(/ /g,'-').replace(/&/g,'-') + ' constituency';
                                g.select('#'+d.id).attr('class', partyclass);
                            }   
                        })
                    }
                });
            }
        }
    })

    svg.append("g")
      .attr("class", "legendOrdinal")
      .attr("transform", "translate(20,20)")
      .append("rect")
      .style("fill","white")
      .attr("width","140")
      .attr("height","290")
      .attr("transform", "translate(-20,-20)");

    svg.select(".legendOrdinal")
        .call(legendOrdinal);


    //Arrows
    directions = [[-50,0],[0,-50],[50,0],[0,50]]
        svg.selectAll('.arrows')        
        .data(directions)
        .enter()
        .append("g")
        .attr("class","arrow")
        .attr("transform", function(d,i) { return "translate(" + (width-40) + ",50)rotate(" + i*90 + ")"})
        .append("polygon")
        .style("fill","none")
        .style("stroke","black")
        .style("fill","black")
        .style("stroke-width","2")
        .style("stroke-linecap","round")
        .style("stroke-linejoin","round")
        .attr("points", "18,-12 30,0 18,12")
        .on("mouseover",function() {
            d3.select(this)
            .transition(100)
            .style("stroke-width","4")
        })
        .on("mouseout",function() {
            d3.select(this)
            .transition(100)
            .style("stroke-width","2")
        })
        .on("click",function(d) { return arrows(d)});


    //Reset circle
    svg.append("path")
    .attr('d',reset)
    .attr("transform", function() { return "translate(" + (width-40) + ",50)scale(1)"})
    .attr('fill',"black")
    .attr('stroke','#000')
    .attr('stroke-width',1)
    .on("mouseover",function() {
            d3.select(this)
            .transition(100)
            .style("stroke-width","4")
        })
    .on("mouseout",function() {
            d3.select(this)
            .transition(100)
            .style("stroke-width","2")
        })
    .on("click",function(d) { return arrows([0,0])});

    //Zoom in +
    svg.append("path")
    .attr('d',zoomin)
    .attr("transform", function() { return "translate(" + (width-40) + ",100)scale(1)"})
    .attr('fill',"black")
    .attr('stroke','#000')
    .attr('stroke-width',"2")
    .on("mouseover",function() {
            d3.select(this)
            .transition(100)
            .style("stroke-width","4")
        })
    .on("mouseout",function() {
            d3.select(this)
            .transition(100)
            .style("stroke-width","2")
        })
    .on("click",function(d) { return arrows([1,1])});


    //Zoom out -
    svg.append("g")
    .attr("transform", function(d,i) { return "translate(" + (width-40) + ",120)"})
        .append("polyline")
        .style("fill","none")
        .style("stroke","black")
        .style("fill","black")
        .style("stroke-width","4")
        .style("stroke-linecap","round")
        .style("stroke-linejoin","round")
        .attr("points", "-10,0 10,0")
        .on("mouseover",function() {
            d3.select(this)
            .transition(100)
            .style("stroke-width","6")
        })
        .on("mouseout",function() {
            d3.select(this)
            .transition(100)
            .style("stroke-width","4")
        })
        .on("click",function(d) { return arrows([-1,-1])});



    //Postcode finder
    $("#postcode").keyup(function(event){
        if(event.keyCode == 13){
            $("#postcodesubmit").click();
        }
    });
    $( "#postcodesubmit" ).click(function() {
        $("#mporconst").val("");
        $.ajax({
            url: 'http://mapit.mysociety.org/postcode/' + $("#postcode").val(),
            type: 'GET',
            success: function(data) {
                //called when successful

                var cons;
                for (c in data.areas) {
                    if(data.areas[c].type == 'WMC') { cons = data.areas[c].name; code = data.areas[c].codes.gss; }
                }
                for (c in constituencies) {
                    if(constituencies[c].properties.id == code) clicked(constituencies[c]);
                }

            
            },
            error: function(e) {
                //called when there is an error
                alert("Please type a complete postcode, e.g., SW1A 1AA")
            }
        });
    });


//Change numbers to string with st, nd, rd or th.
function NumStr(n) {
    var number = n.toString();
    if (number.slice(0,1) == "1" && number.length > 1) return n+"th";
    else if (number.slice(-1) == "1") return n+"st";
    else if (number.slice(-1) == "2") return n+"nd";
    else if (number.slice(-1) == "3") return n+"rd";
    else return n+"th";

}

    $( "#ranks" ).change(function() {
    var rankedOffice = 1,
    rankedStaff = 1,
    rankedAccom = 1,
    rankedTS = 1,
    rankedOverall = 1;

        ranks = $( "#ranks" ).val().split(",");
        for (a=0;a<ranks.length;a++) {
            for (b=0; b<constituencies.length; b++) {
                if(ranks[a] == constituencies[b].id) {
                    if(parseFloat(constituencies[b].costsThisYear.office_costs_spend_against_budget)<parseFloat($("#officespend").html().replace("£", ""))) {
                    rankedOffice++}
                    if(parseFloat(constituencies[b].costsThisYear.staff_spend_against_budget)<parseFloat($("#staffspend").html().replace("£", ""))) {
                    rankedStaff++}
                    if(parseFloat(constituencies[b].costsThisYear.accom_spend_against_budget)<parseFloat($("#accomspend").html().replace("£", ""))) {
                    rankedAccom++}
                    if(parseFloat(constituencies[b].costsThisYear.ts_spend_against_budget)<parseFloat($("#tsspend").html().replace("£", ""))) {
                    rankedTS++}
                    if(parseFloat(constituencies[b].costsThisYear.overall_total_spend)<parseFloat($("#overallspend").html().replace("£", ""))) {
                    rankedOverall++}

                }
            }
        }
        $("#officerank").html(NumStr(rankedOffice) + "/" + NumStr(ranks.length+1));
        $("#staffrank").html(NumStr(rankedStaff) + "/" + NumStr(ranks.length+1));
        $("#accomrank").html(NumStr(rankedAccom) + "/" + NumStr(ranks.length+1));
        $("#tsrank").html(NumStr(rankedTS) + "/" + NumStr(ranks.length+1));
        $("#overallrank").html(NumStr(rankedOverall) + "/" + NumStr(ranks.length+1));
    });

  $(function() {
        $( "#mporconst" ).catcomplete({
          delay: 0,
          source: mporconstdata,
          select: function( event, ui ) {
            $( "#mporconst" ).val( ui.item.label );
            mporconstdataclicked = ui.item.data;
            return false;
          }
        });
      });

    $("#mporconst").keyup(function(event){
        if(event.keyCode == 13){
            $("#mporconstsubmit").click();
        }
    });

    $( "#mporconstsubmit" ).click(function() {
        $("#postcode").val("");
        clicked(mporconstdataclicked);

    });
}

// click to zoom
function clicked(d) { 
  
    var x, y, k, b, bx, by;

    $('body').one("click", function(event) {

        if (d && centered !== d) {
            var nearbyconstituencies = [];
            $.ajax({
                url: 'http://mapit.mysociety.org/area/' + d.id,
                type: 'GET',
                dataType: 'jsonp',
                //async: false,
                success: function(data) {
                    //called when successful
                    $.ajax({
                        url:'http://mapit.mysociety.org/area/'+data.id+'/touches?type=WMC',
                        type: 'GET',
                        //async: false,
                        dataType: 'jsonp',
                        success: function(data) {

                            for (c in data) {
                                nearbyconstituencies.push(data[c].codes.gss)
                            }

                            $("#ranks").val( nearbyconstituencies ).trigger('change');
                        }

                    })

                
                },
                error: function(e) {
                    //called when there is an error
                    alert("Error")
                }
            });
            

            height = window.innerHeight-$("#navbar").height() - 20 - 250;
            svg
            .attr('height', height);
            svg.select("rect")
            .attr("height", height);

            bx = path.bounds(d)[1][0]-path.bounds(d)[0][0];
            by = path.bounds(d)[1][1]-path.bounds(d)[0][1];
            if (bx > by) {b = bx} else {b = by}
            k = 400/b;
            if (k > 15) k = 15;
            var centroid = path.centroid(d);
            x = centroid[0];
            y = centroid[1];

            zoom.translate([((width/2)+(-x*k)),((height/2)+(-y*k))]);
            zoom.scale(k);
            centered = d;

            $("#details").width(width-40);
            $("#details").show();
            $("#mpname").html(d.mp);
            $("#constituency").html(d.constituency_name);
            $("#party").html(d.partyName + " / Votes: " + d.shareVotes + "%");

            officebudget = parseInt((parseFloat(d.costsThisYear.office_costs_spend_against_budget.replace(',',''))/parseFloat(d.costsThisYear.office_costs_maximum_budget_available.replace(',','')))*100);
            officechange = parseInt(parseFloat(d.costsThisYear.office_costs_spend_against_budget.replace(',',''))/parseFloat(d.costLastYear.office_costs_spend_against_budget.replace(',',''))*100)-100;

            if(officechange >0) {
                officearrow = "<span class='glyphicon glyphicon-arrow-up red' aria-hidden='true'></span>"
            } else if (officechange <0){
                 officearrow = "<span class='glyphicon glyphicon-arrow-down green' aria-hidden='true'></span>" 
             } else { officearrow = ""; } 

            staffbudget = parseInt((parseFloat(d.costsThisYear.staff_spend_against_budget.replace(',',''))/parseFloat(d.costsThisYear.staff_maximum_budget_available.replace(',','')))*100);
            staffchange = parseInt(parseFloat(d.costsThisYear.staff_spend_against_budget.replace(',',''))/parseFloat(d.costLastYear.staff_spend_against_budget.replace(',',''))*100)-100;

            if(staffchange >0) {
                staffarrow = "<span class='glyphicon glyphicon-arrow-up red' aria-hidden='true'></span>"
            } else if (staffchange <0){
                 staffarrow = "<span class='glyphicon glyphicon-arrow-down green' aria-hidden='true'></span>" 
             } else { staffarrow = ""; }        

            accombudget = parseInt((parseFloat(d.costsThisYear.accom_spend_against_budget.replace(',',''))/parseFloat(d.costsThisYear.accom_maximum_budget_available.replace(',','')))*100);
            accomchange = parseInt(parseFloat(d.costsThisYear.accom_spend_against_budget.replace(',',''))/parseFloat(d.costLastYear.accom_spend_against_budget.replace(',',''))*100)-100;

            if(accomchange >0) {
                accomarrow = "<span class='glyphicon glyphicon-arrow-up red' aria-hidden='true'></span>"
            } else if (accomchange <0){
                 accomarrow = "<span class='glyphicon glyphicon-arrow-down green' aria-hidden='true'></span>" 
             } else { accomarrow = ""; }


            tschange = parseInt(parseFloat(d.costsThisYear.ts_spend_against_budget.replace(',',''))/parseFloat(d.costLastYear.ts_spend_against_budget.replace(',',''))*100)-100;

            if(tschange >0) {
                tsarrow = "<span class='glyphicon glyphicon-arrow-up red' aria-hidden='true'></span>"
            } else if (tschange <0){
                 tsarrow = "<span class='glyphicon glyphicon-arrow-down green' aria-hidden='true'></span>" 
             } else { tsarrow = ""; }

            //overallbudget = parseInt((parseFloat(d.costsThisYear.overall_total_spend.replace(',',''))/parseFloat(d.costsThisYear.overall_total_spend.replace(',','')))*100);
            overallchange = parseInt(parseFloat(d.costsThisYear.overall_total_spend.replace(',',''))/parseFloat(d.costLastYear.overall_total_spend.replace(',',''))*100)-100;

            if(overallchange >0) {
                overallarrow = "<span class='glyphicon glyphicon-arrow-up red' aria-hidden='true'></span>"
            } else if (overallchange <0){
                 overallarrow = "<span class='glyphicon glyphicon-arrow-down green' aria-hidden='true'></span>" 
             } else { overallarrow = ""; }


            if(isNaN(accombudget)) {accombudget = "N/A"} else {accombudget = accombudget+"%"}
            if(isNaN(accomchange)) {accomchange = "N/A"} else {accomchange = accomchange+"%"}
            if(isNaN(officebudget)) {officebudget = "N/A"} else {officebudget = officebudget+"%"}
            if(isNaN(officechange)) {officechange = "N/A"} else {officechange = officechange+"%"}
            if(isNaN(staffbudget)) {staffbudget = "N/A"} else {staffbudget = staffbudget+"%"}
            if(isNaN(staffchange)) {staffchange = "N/A"} else {staffchange = staffchange+"%"}
            if(isNaN(tschange)) {tschange = "N/A"} else {tschange = tschange+"%"}
            if(isNaN(overallchange)) {overallchange = "N/A"} else {overallchange = overallchange+"%"}



            var table_body = "<thead><th>Type of Expense</th><th>Amount</th><th>% budget used</th><th>% change last year</th><th>Local Ranking</th></thead>"
            table_body += "<tbody><tr><td>Office</td><td id='officespend'>£"+d.costsThisYear.office_costs_spend_against_budget+"</td><td>"+officebudget+"</td><td>"+officechange+officearrow+"</td><td id='officerank'>Loading...</td></tr>";
            table_body += "<tr><td>Staff</td><td id='staffspend'>£"+d.costsThisYear.staff_spend_against_budget+"</td><td>"+staffbudget+"</td><td>"+staffchange+staffarrow+"</td><td id='staffrank'>Loading...</td></tr>";
            table_body += "<tr><td>Accommodation</td><td id='accomspend'>£"+d.costsThisYear.accom_spend_against_budget+"</td><td>"+accombudget+"</td><td>"+accomchange+accomarrow+"</td><td id='accomrank'>Loading...</td></tr>";
            table_body += "<tr><td>Travel & Subsistence</td><td id='tsspend'>£"+d.costsThisYear.ts_spend_against_budget+"</td><td>N/A</td><td>"+tschange+tsarrow+"</td><td id='tsrank'>Loading...</td></tr>";
            table_body += "<tr><td><strong>Overall</strong></td><td id='overallspend'>£"+d.costsThisYear.overall_total_spend+"</td><td>N/A</td><td>"+overallchange+overallarrow+"</td><td id='overallrank'>Loading...</td></tr></tbody>";

            $("#mptable").html(table_body);
            $("#moreinfo").attr("href","javascript:lightbox('" + d.mp + "');");

        }
        else {

            height = window.innerHeight-$("#navbar").height() - 20;

            svg
            .attr('height', height);
            svg.select("rect")
            .attr("height", height);

            
            
            if (regionzoom>1) {
                zoom.scale(regionzoom)
                zoom.translate(regiontranslate)
            } else {
                zoom.scale(1);
                zoom.translate([0,0]);
            }  

            centered = null;
            $("#details").hide();
            $("#details").width(0);
        }
        g.selectAll("path")
        .classed("active", centered && function(d) { return d === centered; });
        g.transition()
        .duration(1250)
        .attr("transform", "translate(" + (zoom.translate()) + ")scale(" + (zoom.scale()) + ")");

    });
}

function arrows(d) {

    if(d[0] == 0 && d[1] == 0) {
        x = 0;
        y = 0;
        zoom.scale(1);
    }
    else if(d[0] == 1 && d[1] == 1) {
        z = zoom.scale()+1;
        if(z>15) z=15;
        x = (zoom.translate()[0]-(width/2))/zoom.scale()
        y = (zoom.translate()[1]-(height/2))/zoom.scale()

        x = (width/2) + (x*z)
        y = (height/2) + (y*z)
        zoom.scale(z);
    }
    else if(d[0] == -1 && d[1] == -1) {
        z = zoom.scale()-1;
        x = (zoom.translate()[0]-(width/2))/zoom.scale()
        y = (zoom.translate()[1]-(height/2))/zoom.scale()

        x = (width/2) + (x*z)
        y = (height/2) + (y*z)
        zoom.scale(z);
    }
    else {
        z = zoom.scale()
        x = zoom.translate()[0] + (d[0]*z);
        y = zoom.translate()[1] + (d[1]*z);
    }   
    zoom.translate([x,y]);
    g.transition()
    .duration(300)
    .attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")"); 
}


function zoomed() {

   g.transition().duration(0)
    .attr("transform", "translate(" + (d3.event.x,d3.event.y) + ")scale(" + (zoom.scale()) + ")");
}


    </script>
  </body>
</html>
