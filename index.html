<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <style>
body { 
    color: #666; 
    /*background: #f3f3f3;*/
    font: normal 10px "Helvetica Neue", Helvetica, sans-serif; 
    /*margin: 2em;*/ 
}     

table {
	border: 1px;
	border-style: dashed;
	border-color: #000000;
}       

#map {
    margin-right: auto;
}

#details {
	padding: 20px;
    border: 2px solid;
    border-radius: 25px;
    background-color: white;
  	position: absolute;
  	left: 90%;
  	top: 20%;
  	transform: translate(-80%, -10%); /* Yep! */
  	opacity: 0;
}

.constituency {
    fill: #e5e5e5;
    /*stroke: #fff;
    stroke-width: 0.25px;*/
}

.background {
  fill: none;
  pointer-events: all;
}

/* party full colors */
.conservatives { fill:rgba(5, 117, 201, 1); }
.labour { fill:rgba(237, 30, 14, 1); }
.snp { fill:rgba(235, 195, 28, 1); }
.liberal-democrats { fill:rgba(254, 131, 0, 1); }
.ukip { fill:rgba(113, 47, 135, 1); }
.green-party { fill:rgba(120, 195, 30, 1); }
.plaid-cymru { fill: rgba(78, 159, 47, 1); } /*Plaid Cymru*/

/* tooltip */
.hidden {
    display: none;
}

div.tooltip {   
    color: #222;
    background: #fff;
    padding: .5em;
    text-shadow: #f5f5f5 0 1px 0;
    border-radius: 2px; 
    box-shadow: 0px 0px 2px 0px #a6a6a6; 
    opacity: 0.9; 
    position: absolute;
}

/* click to zoom */

.active {
    /*fill: orange;
    stroke: #fff;
    stroke-width: 1.5px;
    stroke-linejoin: round;
    stroke-linecap: round;
    pointer-events: none;
    fill: rgba(255,255,255,0.2);
    */
    fill-opacity: 0.8;
}
        </style>
    </head>
    <body>
        <div id='map'></div>
        <script src="d3.min.js"></script>
        <script src="queue.v1.min.js"></script>
        <script src="topojson.v1.min.js"></script>
        <script src="jquery.min.js"></script>
        <script>

// create map

var width = window.innerWidth-20,
    height = window.innerHeight-20
    // click to zoom
    , centered
;

var projection = d3.geo.albers()
    //.center([0, 55.4])
    .center([3, 54])
    .rotate([4.4, 0])
    .parallels([50, 60])
    .scale(4000)
    .translate([width / 2, height / 2])
    //.translate(200,200)
    ;

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select('#map').append('svg')
    .attr('width', width)
    .attr('height', height)
;

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    // zoom to click
    .on("click", clicked);

var g = svg.append("g");

// tooltip
var tooltip = d3.select('#map').append('div')
    .attr('class', 'tooltip')
;

// load files
queue()
    .defer(d3.json, "data/constituencies-wni.topo.json")
    .defer(d3.tsv, "data/vw_uk_voting_winners_extract.tsv")
    .defer(d3.csv, "data/export-2014.csv")
    .defer(d3.csv, "data/export-2013.csv")
    .await(ready) // ready refers to function below
;

function ready(error, topology, electionData,ipsaData14,ipsaData13) {
    // console.log(topology);
    // console.log(electionData);
    // console.log(ipsaData14);



    var constituencies = topojson.feature(topology, topology.objects.constituencies).features;
    var n = constituencies.length;
    // console.log(constituencies);

    // join datasets
    // we will add the missing data points to the consituencies object
    
    constituencies.forEach(function(d){
        
        featureData = electionData.filter(
        function(n){ 
            return d.id == n.ons_gss_code
        })
        ;
        
        d.constituencyName = featureData[0].constituency_name;
        d.partyName = featureData[0].party_name;
        d.shareVotes = featureData[0].share_votes;

        featureData14 = ipsaData14.filter(
        function(n){ 
            if (n.constituency.substring(n.constituency.length-1,n.constituency.length) == 'C') {
                n.constituency = n.constituency.substring(0,n.constituency.length-3)
            }
            return d.properties.PCON13NM == n.constituency;
        })
        ;

        featureData13 = ipsaData13.filter(
        function(n){ 
            if (n.constituency.substring(n.constituency.length-1,n.constituency.length) == 'C') {
                n.constituency = n.constituency.substring(0,n.constituency.length-3)
            }
            return d.properties.PCON13NM == n.constituency;
        })
        ;
        
        d.mp = featureData14[0].mp_name;
        d.costs14 = featureData14[0];
        d.costs13 = featureData13[0];

        
    })
    ;
    
     console.log(constituencies);
    
    // create a polygon for every constituency
    g.selectAll('.constituency')
        .data(constituencies)
        .enter()
        .insert('path')
        // assign id from feature data
        .attr('id', function(d) { return d.id; })
        .attr('d', path)
        .attr('class', function(d){
            return (d.partyName).toLocaleLowerCase().replace(' ','-')
                + ' constituency';
        })   
        // tooltip
        .on('mousemove', function(d,i){
            var mouse = d3.mouse(svg.node()).map(
                function (d) {
                    return parseInt(d);
                }
            )
            ;
            
            tooltip
                .classed('hidden', false)
                .attr('style', 'left:' + (mouse[0]+25) + 'px; top:' + mouse[1] + 'px')
                // tooltip text:
                .html(
                    '<b>' + d.mp + '</b><br />'
                    + '<b>' + d.constituencyName + '</b></br>' 
                    + d.partyName + '</br>' 
                    + d.shareVotes + '%'
                )
            
        })
        .on('mouseout', function(d,i){
            tooltip.classed('hidden', true)
        })
        // zoom to click
        .on('click', clicked);
        ;


    // draw borders seperately to not get any overlapping borders
    /**
    var constituenciesBorders = topojson.mesh(
        topology, topology.objects.constituencies, function(a, b) { 
            return a !== b; 
        }
    );

    g.append("path")
        .datum(constituenciesBorders)
        .attr("class", "constituency-borders")
        .attr("d", path);
    **/
}

// click to zoom
function clicked(d) {
    var x, y, k;

    if (d && centered !== d) {
        var centroid = path.centroid(d);
        x = centroid[0];
        y = centroid[1];
        k = 6;
        centered = d;
        $("#details").show();
        $("#details").css("opacity","1");
        $("#mpname").html(d.mp);
        $("#constituency").html(d.constituencyName);
        $("#party").html(d.partyName + " / Votes: " + d.shareVotes + "%");

        console.log(d.costs13.staff_spend_against_budget);


        officebudget = parseInt((parseFloat(d.costs14.office_costs_spend_against_budget.replace(',',''))/parseFloat(d.costs14.office_costs_maximum_budget_available.replace(',','')))*100);
        officechange = parseInt(parseFloat(d.costs14.office_costs_spend_against_budget.replace(',',''))/parseFloat(d.costs13.office_costs_spend_against_budget.replace(',',''))*100)-100;

        staffbudget = parseInt((parseFloat(d.costs14.staff_spend_against_budget.replace(',',''))/parseFloat(d.costs14.staff_maximum_budget_available.replace(',','')))*100);
        staffchange = parseInt(parseFloat(d.costs14.staff_spend_against_budget.replace(',',''))/parseFloat(d.costs13.staff_spend_against_budget.replace(',',''))*100)-100;

        accombudget = parseInt((parseFloat(d.costs14.accom_spend_against_budget.replace(',',''))/parseFloat(d.costs14.accom_maximum_budget_available.replace(',','')))*100);
        accomchange = parseInt(parseFloat(d.costs14.accom_spend_against_budget.replace(',',''))/parseFloat(d.costs13.accom_spend_against_budget.replace(',',''))*100)-100;

        tsbudget = parseInt((parseFloat(d.costs14.ts_spend_against_budget.replace(',',''))/parseFloat(d.costs14.ts_maximum_budget_available.replace(',','')))*100);
        tschange = parseInt(parseFloat(d.costs14.ts_spend_against_budget.replace(',',''))/parseFloat(d.costs13.ts_spend_against_budget.replace(',',''))*100)-100;

        overallbudget = parseInt((parseFloat(d.costs14.overall_total_spend.replace(',',''))/parseFloat(d.costs14.overall_total_spend.replace(',','')))*100);
        overallchange = parseInt(parseFloat(d.costs14.overall_total_spend.replace(',',''))/parseFloat(d.costs13.overall_total_spend.replace(',',''))*100)-100;        


        var table_body = "<thead><th>Type of Expense</th><th>Amount</th><th>% budget used</th><th>% change last year</th><th>Local Ranking</th></thead>"
        table_body += "<tr><td>Office</td><td>£"+d.costs14.office_costs_spend_against_budget+"</td><td>"+officebudget+"%</td><td>"+officechange+"%</td><td>1st</td></tr>";
        table_body += "<tr><td>Staff</td><td>£"+d.costs14.staff_spend_against_budget+"</td><td>"+staffbudget+"%</td><td>"+staffchange+"%</td><td>1st</td></tr>";
        table_body += "<tr><td>Accommodation</td><td>£"+d.costs14.accom_spend_against_budget+"</td><td>"+accombudget+"%</td><td>"+accomchange+"%</td><td>1st</td></tr>";
        table_body += "<tr><td>Travel & Substitnence</td><td>£"+d.costs14.ts_spend_against_budget+"</td><td>"+tsbudget+"%</td><td>"+tschange+"%</td><td>1st</td></tr>";
        table_body += "<tr><td>Overall</td><td>£"+d.costs14.overall_total_spend+"</td><td>"+overallbudget+"%</td><td>"+overallchange+"%</td><td>1st</td></tr>";



        $("#mptable").html(table_body);
    } else {
        x = width / 2;
        y = height / 2;
        k = 1;
        centered = null;
        $("#details").hide();
    }

    g.selectAll("path")
        .classed("active", centered && function(d) { return d === centered; });

    g.transition()
        .duration(750)
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
        .style("stroke-width", 1.5 / k + "px"); 
}
        </script>

        <div id="details">
        	<h1 id="mpname"></h1>
        	<h2 id="constituency"></h2>
        	<p id="party"></p>
        	<table id="mptable"></table>
        </div>

    </body>
</html>
