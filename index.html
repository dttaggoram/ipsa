
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Independent Parliamentary Standards Authority - MP Expenses</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- D3  CSS -->
    <link href="css/d3.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="css/dashboard.css" rel="stylesheet">


    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  </head>

  <body>

    <nav id="navbar" class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">//Test</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="#">Help</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-3 col-md-2 sidebar">
                <h2>Filters</h2>
                <br />
                <div class="input-group" >
                    <span class="input-group-addon" id="basic-addon3">2014-15</span>
                  <div class="input-group-btn">
                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Year <span class="caret"></span></button>
                    <ul class="dropdown-menu dropdown-menu-right">
                        <li><a href="#">2014-15</a></li>
                        <li><a href="#">2013-14</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="#">2010-15</a></li>
                    </ul>
                  </div><!-- /btn-group -->
                </div><!-- /input-group -->
                <br />
                <span class="label label-default">Postcode Finder</span>
                <div class="input-group">               
                  <input id="postcode" type="text" class="form-control" placeholder="Postcode">
                  <span class="input-group-btn">
                    <button id="postcodesubmit" class="btn btn-default" type="button">Find</button>
                  </span>
                </div>
                <br />
                <span class="label label-default">MP Finder</span>                
                <div class="input-group">
                  <input id="mporconst" type="text" class="form-control" placeholder="MP">
                  <span class="input-group-btn">
                    <button id="mporconstsubmit" class="btn btn-default" type="button">Find</button>
                  </span>
                </div>
            </div>
            <div id="mainsection" class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
              <div id='map'></div>
            </div>
        </div>
    </div>
    <div id="details">
        <div class="row">
            <div class="col-sm-12 col-md-4">
                <h1 id="mpname"></h1>
                <h2 id="constituency"></h2>
                <p id="party"></p>
                <input type="hidden" id="ranks" value="" />
            </div>
            <div class="col-sm-12 col-md-8">
                <table id="mptable" class="table table-striped"></table>
            </div>
        </div>
    </div> 

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="js/jquery.min.js"></script>
    <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="js/ie10-viewport-bug-workaround.js"></script>

    <!-- D3 Javscript
    ================================================== -->
    <script src="js/d3.min.js"></script>
    <script src="js/queue.v1.min.js"></script>
    <script src="js/topojson.v1.min.js"></script>
    <script>
      $.widget( "custom.catcomplete", $.ui.autocomplete, {
        _create: function() {
          this._super();
          this.widget().menu( "option", "items", "> :not(.ui-autocomplete-category)" );
        },
        _renderMenu: function( ul, items ) {
          var that = this,
            currentCategory = "";
          $.each( items, function( index, item ) {
            var li;
            if ( item.category != currentCategory ) {
              ul.append( "<li class='ui-autocomplete-category'>" + item.category + "</li>" );
              currentCategory = item.category;
            }
            li = that._renderItemData( ul, item );
            if ( item.category ) {
              li.attr( "aria-label", item.category + " : " + item.label );
            }
          });
        }
      });
    </script>
    <script>

// create map

var width = $("#mainsection").width()+70,
    height = window.innerHeight-$("#navbar").height() - 20
    // click to zoom
    , centered
;

var projection = d3.geo.albers()
    //.center([0, 55.4])
    .center([3, 54.4])
    .rotate([4.4, 0])
    .parallels([50, 60])
    .scale(4500)
    .translate([width / 2, height / 2])
    //.translate(200,200)
    ;

var zoom = d3.behavior.zoom()
    .scaleExtent([1, 10])
    .on("zoom", zoomed);


var path = d3.geo.path()
    .projection(projection);

var svg = d3.select('#map').append('svg')
    .attr('width', width)
    .attr('height', height)
;

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    // zoom to click
    .on("click", clicked)
    .call(zoom);

var g = svg.append("g");

// tooltip
var tooltip = d3.select('#map').append('div')
    .attr('class', 'tooltip')
;

// load files
queue()
    .defer(d3.json, "data/constituencies-wni.topo.json")
    .defer(d3.tsv, "data/election-2010results.tsv")
    .defer(d3.csv, "data/export-2014.csv")
    .defer(d3.csv, "data/export-2013.csv")
    .await(ready) // ready refers to function below
;

function ready(error, topology, electionData,ipsaData14,ipsaData13) {
    // console.log(topology);
    // console.log(electionData);
    // console.log(ipsaData14);



    var constituencies = topojson.feature(topology, topology.objects.constituencies).features;
    var n = constituencies.length;
    var mporconstdata = [];
    // console.log(constituencies);

    // join datasets
    // we will add the missing data points to the consituencies object
    
    constituencies.forEach(function(d){
        
        featureData = electionData.filter(
        function(n){ 
            return d.id == n.ons_gss_code
        })
        ;
        
        d.constituencyName = featureData[0].constituency_name;
        d.partyName = featureData[0].party_name;
        d.shareVotes = featureData[0].share_votes;

        featureData14 = ipsaData14.filter(
        function(n){ 
            if (n.constituency.substring(n.constituency.length-1,n.constituency.length) == 'C') {
                n.constituency = n.constituency.substring(0,n.constituency.length-3)
            }
            return d.properties.PCON13NM == n.constituency;
        })
        ;

        featureData13 = ipsaData13.filter(
        function(n){ 
            if (n.constituency.substring(n.constituency.length-1,n.constituency.length) == 'C') {
                n.constituency = n.constituency.substring(0,n.constituency.length-3)
            }
            return d.properties.PCON13NM == n.constituency;
        })
        ;
        
        d.mp = featureData14[0].mp_name;
        d.costs14 = featureData14[0];
        d.costs13 = featureData13[0];

        mporconstdata.push({ label: d.mp, category: "MP", data:d });
        mporconstdata.push({ label: d.constituencyName, category: "Constituency", data:d })
        
    })
    ;
    
    // console.log(constituencies);
    
    // create a polygon for every constituency
    g.selectAll('.constituency')
        .data(constituencies)
        .enter()
        .insert('path')
        // assign id from feature data
        .attr('id', function(d) { return d.id; })
        .attr('d', path)
        .attr('class', function(d){
            return (d.partyName).toLocaleLowerCase().replace(/ /g,'-')
                + ' constituency';
        })   
        // tooltip
        .on('mousemove', function(d,i){
            var mouse = d3.mouse(svg.node()).map(
                function (d) {
                    return parseInt(d);
                }
            )
            ;

            tooltip
                .classed('hidden', false)
                .attr('style', 'left:' + (mouse[0]-(d.constituencyName.length)*6) + 'px; top:' + (mouse[1]+30) + 'px')
                // tooltip text:
                .html(
                    '<b>' + d.mp + '</b><br />'
                    + '<b>' + d.constituencyName + '</b></br>' 
                    + d.partyName + '</br>' 
                    + d.shareVotes + '%'
                )
            
        })
        .on('mouseout', function(d,i){
            tooltip.classed('hidden', true)
        })
        // zoom to click
        .on('click', clicked);
        ;

    $("#postcode").keyup(function(event){
        if(event.keyCode == 13){
            $("#postcodesubmit").click();
        }
    });

    $( "#postcodesubmit" ).click(function() {
        $.ajax({
            url: 'http://mapit.mysociety.org/postcode/' + $("#postcode").val(),
            type: 'GET',
            success: function(data) {
                //called when successful
                var cons;
                for (c in data.areas) {
                    if(data.areas[c].type == 'WMC') { cons = data.areas[c].name; code = data.areas[c].codes.gss; }
                }

                for (c in constituencies) {
                    if(constituencies[c].id == code) clicked(constituencies[c]);
                }

            
            },
            error: function(e) {
                //called when there is an error
                alert("Please type a complete postcode, e.g., SW1A 1AA")
            }
        });
    });



    $( "#ranks" ).change(function() {
    var rankedOffice = 1,
    rankedStaff = 1,
    rankedAccom = 1,
    rankedTS = 1,
    rankedOverall = 1;

        ranks = $( "#ranks" ).val().split(",");
        for (a=0;a<ranks.length;a++) {
            for (b=0; b<constituencies.length; b++) {
                if(ranks[a] == constituencies[b].properties.PCON13CD) {
                    if(parseFloat(constituencies[b].costs14.office_costs_spend_against_budget)<parseFloat($("#officespend").html().replace("£", ""))) {
                    rankedOffice++}
                    if(parseFloat(constituencies[b].costs14.staff_spend_against_budget)<parseFloat($("#staffspend").html().replace("£", ""))) {
                    rankedStaff++}
                    if(parseFloat(constituencies[b].costs14.accom_spend_against_budget)<parseFloat($("#accomspend").html().replace("£", ""))) {
                    rankedAccom++}
                    if(parseFloat(constituencies[b].costs14.ts_spend_against_budget)<parseFloat($("#tsspend").html().replace("£", ""))) {
                    rankedTS++}
                    if(parseFloat(constituencies[b].costs14.overall_total_spend)<parseFloat($("#overallspend").html().replace("£", ""))) {
                    rankedOverall++}

                }
            }
        }
        $("#officerank").html(rankedOffice + "/" + (ranks.length+1));
        $("#staffrank").html(rankedStaff + "/" + (ranks.length+1));
        $("#accomrank").html(rankedAccom + "/" + (ranks.length+1));
        $("#tsrank").html(rankedTS + "/" + (ranks.length+1));
        $("#overallrank").html(rankedOverall + "/" + (ranks.length+1));
    });

  $(function() {
        $( "#mporconst" ).catcomplete({
          delay: 0,
          source: mporconstdata,
          select: function( event, ui ) {
            $( "#mporconst" ).val( ui.item.label );
            mporconstdataclicked = ui.item.data;
            return false;
          }
        });
      });

    $("#mporconst").keyup(function(event){
        if(event.keyCode == 13){
            $("#mporconstsubmit").click();
        }
    });

    $( "#mporconstsubmit" ).click(function() {
        clicked(mporconstdataclicked);

    });
}

// click to zoom
function clicked(d) {
    var x, y, k, b, bx, by;
    
        var nearbyconstituencies = [];
        $.ajax({
            url: 'http://mapit.mysociety.org/area/' + d.id,
            type: 'GET',
            dataType: 'jsonp',
            //async: false,
            success: function(data) {
                //called when successful
                $.ajax({
                    url:'http://mapit.mysociety.org/area/'+data.id+'/touches?type=WMC',
                    type: 'GET',
                    //async: false,
                    dataType: 'jsonp',
                    success: function(data) {

                        for (c in data) {
                            nearbyconstituencies.push(data[c].codes.gss)
                        }

                        $("#ranks").val( nearbyconstituencies ).trigger('change');
                    }

                })

            
            },
            error: function(e) {
                //called when there is an error
                alert("Error")
            }
        });


    if (d && centered !== d) {
        //console.log(nearbyconstituencies)
        var centroid = path.centroid(d);
        x = centroid[0];
        y = centroid[1];
        bx = path.bounds(d)[1][0]-path.bounds(d)[0][0];
        by = path.bounds(d)[1][1]-path.bounds(d)[0][1];
        if (bx > by) {b = bx} else {b = by}
        k = 400/b;
        centered = d;

        height = window.innerHeight-$("#navbar").height() - 20 - 250;

        svg
        .attr('height', height);

        svg.select("rect")
        .attr("height", height);

        $("#details").width(width-40);
        $("#details").show();
        $("#mpname").html(d.mp);
        $("#constituency").html(d.constituencyName);
        $("#party").html(d.partyName + " / Votes: " + d.shareVotes + "%");

        officebudget = parseInt((parseFloat(d.costs14.office_costs_spend_against_budget.replace(',',''))/parseFloat(d.costs14.office_costs_maximum_budget_available.replace(',','')))*100);
        officechange = parseInt(parseFloat(d.costs14.office_costs_spend_against_budget.replace(',',''))/parseFloat(d.costs13.office_costs_spend_against_budget.replace(',',''))*100)-100;

        if(officechange >0) {
            officearrow = "<span class='glyphicon glyphicon-arrow-up red' aria-hidden='true'></span>"
        } else if (officechange <0){
             officearrow = "<span class='glyphicon glyphicon-arrow-down green' aria-hidden='true'></span>" 
         } else { officearrow = ""; } 

        staffbudget = parseInt((parseFloat(d.costs14.staff_spend_against_budget.replace(',',''))/parseFloat(d.costs14.staff_maximum_budget_available.replace(',','')))*100);
        staffchange = parseInt(parseFloat(d.costs14.staff_spend_against_budget.replace(',',''))/parseFloat(d.costs13.staff_spend_against_budget.replace(',',''))*100)-100;

        if(staffchange >0) {
            staffarrow = "<span class='glyphicon glyphicon-arrow-up red' aria-hidden='true'></span>"
        } else if (staffchange <0){
             staffarrow = "<span class='glyphicon glyphicon-arrow-down green' aria-hidden='true'></span>" 
         } else { staffarrow = ""; }        

        accombudget = parseInt((parseFloat(d.costs14.accom_spend_against_budget.replace(',',''))/parseFloat(d.costs14.accom_maximum_budget_available.replace(',','')))*100);
        accomchange = parseInt(parseFloat(d.costs14.accom_spend_against_budget.replace(',',''))/parseFloat(d.costs13.accom_spend_against_budget.replace(',',''))*100)-100;

        if(accomchange >0) {
            accomarrow = "<span class='glyphicon glyphicon-arrow-up red' aria-hidden='true'></span>"
        } else if (accomchange <0){
             accomarrow = "<span class='glyphicon glyphicon-arrow-down green' aria-hidden='true'></span>" 
         } else { accomarrow = ""; }


        tschange = parseInt(parseFloat(d.costs14.ts_spend_against_budget.replace(',',''))/parseFloat(d.costs13.ts_spend_against_budget.replace(',',''))*100)-100;

        if(tschange >0) {
            tsarrow = "<span class='glyphicon glyphicon-arrow-up red' aria-hidden='true'></span>"
        } else if (tschange <0){
             tsarrow = "<span class='glyphicon glyphicon-arrow-down green' aria-hidden='true'></span>" 
         } else { tsarrow = ""; }

        overallbudget = parseInt((parseFloat(d.costs14.overall_total_spend.replace(',',''))/parseFloat(d.costs14.overall_total_spend.replace(',','')))*100);
        overallchange = parseInt(parseFloat(d.costs14.overall_total_spend.replace(',',''))/parseFloat(d.costs13.overall_total_spend.replace(',',''))*100)-100;

        if(overallchange >0) {
            overallarrow = "<span class='glyphicon glyphicon-arrow-up red' aria-hidden='true'></span>"
        } else if (overallchange <0){
             overallarrow = "<span class='glyphicon glyphicon-arrow-down green' aria-hidden='true'></span>" 
         } else { overallarrow = ""; }                


        var table_body = "<thead><th>Type of Expense</th><th>Amount</th><th>% budget used</th><th>% change last year</th><th>Local Ranking</th></thead>"
        table_body += "<tbody><tr><td>Office</td><td id='officespend'>£"+d.costs14.office_costs_spend_against_budget+"</td><td>"+officebudget+"%</td><td>"+officechange+"%"+officearrow+"</td><td id='officerank'></td></tr>";
        table_body += "<tr><td>Staff</td><td id='staffspend'>£"+d.costs14.staff_spend_against_budget+"</td><td>"+staffbudget+"%</td><td>"+staffchange+"%"+staffarrow+"</td><td id='staffrank'>1st</td></tr>";
        table_body += "<tr><td>Accommodation</td><td id='accomspend'>£"+d.costs14.accom_spend_against_budget+"</td><td>"+accombudget+"%</td><td>"+accomchange+"%"+accomarrow+"</td><td id='accomrank'>1st</td></tr>";
        table_body += "<tr><td>Travel & Subsistence</td><td id='tsspend'>£"+d.costs14.ts_spend_against_budget+"</td><td>N/A</td><td>"+tschange+"%"+tsarrow+"</td><td id='tsrank'>1st</td></tr>";
        table_body += "<tr><td><strong>Overall</strong></td><td id='overallspend'>£"+d.costs14.overall_total_spend+"</td><td>"+overallbudget+"%</td><td>"+overallchange+"%"+overallarrow+"</td><td id='overallrank'>1st</td></tr></tbody>";



        $("#mptable").html(table_body);
    } else {

        height = window.innerHeight-$("#navbar").height() - 20;

        x = width / 2;
        y = height / 2;
        k = 1;
        centered = null;
        $("#details").hide();
        $("#details").width(0);

        svg
        .attr('height', height);

        svg.select("rect")
        .attr("height", height);
    }

    g.selectAll("path")
        .classed("active", centered && function(d) { return d === centered; });

    g.transition()
        .duration(1250)
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")scale(" + k + ")translate(" + -x + "," + -y + ")")
        .style("stroke-width", 1.5 / k + "px"); 
}

function zoomed() {
    d3.select("g").attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}


    </script>
  </body>
</html>
